<html>
  <head>
    <meta charset="utf-8" />
    <script src="https://unpkg.com/three@0.140.2/build/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/7/Stats.min.js" integrity="sha512-ey3wf3z1WUgQ6/XU/lV1UVQkbCpWsyQANkBst88XXWHok9fXKp55G365lLhScYihGpkzhiZz75r+8isUSCKRIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
      // ページの読み込みを待つ
      window.addEventListener('DOMContentLoaded', init);
      function init() {
        const stats = new Stats();
        document.body.appendChild(stats.domElement);
        // サイズを指定
        // const width = 1080;
        // const height = 720;
        const width = 800;
        const height = 800;
        var radius = parseInt(document.getElementById('radius').value);

        // レンダラーを作成
        const renderer = new THREE.WebGLRenderer({
          canvas: document.querySelector('#myCanvas'),
        });
        renderer.setSize(width, height);

        // シーンを作成
        const scene = new THREE.Scene();

        // カメラを作成
        const camera = new THREE.PerspectiveCamera(30, width / height, 500, 3000);
        // camera.position.set(0, 0, +1000);
        var isNorth = parseInt(document.getElementById('perspective').value);
        camera.position.set(0, isNorth * 1000, 0);
        camera.lookAt(new THREE.Vector3(0,0,0));

        // 太陽方向;
        const points = [];
        points.push(new THREE.Vector3(0, 0, 0));
        points.push(new THREE.Vector3(width*5, 0, 0)); // sun
        const solar = new THREE.Line(
          new THREE.BufferGeometry().setFromPoints(points),
          new THREE.LineBasicMaterial({color: 0x0000ff})
        );
        const points1 = [];
        points1.push(new THREE.Vector3(-150, 0, 0));
        points1.push(new THREE.Vector3(width*5, 0, 0)); //moon
        const lunar = new THREE.Line(
          new THREE.BufferGeometry().setFromPoints(points1),
          new THREE.LineBasicMaterial({color: 0x0000aa})
        );

        // 球体を作成
        const geometry = new THREE.SphereGeometry(radius, 24, 24);
        // const wireframe = new THREE.WireframeGeometry(geometry, 0x00ff00);
        // const line = new THREE.LineSegments(wireframe);

        // 画像を読み込む
        const loader = new THREE.TextureLoader();
        const texture = loader.load('img/earthmap1k.jpg');
        // マテリアルにテクスチャーを設定
        const material = new THREE.MeshStandardMaterial({
          map: texture,
          // transparent: true,
          transparent: false,
          opacity: 0.5
        });
        // メッシュを作成
        const earth = new THREE.Mesh(geometry, material);
        // 3D空間にメッシュを追加
        scene.add(earth);
        scene.add(solar);
        scene.add(lunar);

        // 平行光源
        const directionalLight = new THREE.DirectionalLight(0xffffff);
        directionalLight.position.set(1, 0, 0);
        //directionalLight.position.set(0, 1, 0);
        // シーンに追加
        scene.add(directionalLight);

        tick();

        // 毎フレーム時に実行されるループイベントです
        function tick() {
          var fov = parseInt(document.getElementById('fov').value);
          var near = parseInt(document.getElementById('near').value);
          var far = parseInt(document.getElementById('far').value);
          camera.fov = fov;
          camera.near = near;
          camera.far = far;
          camera.updateProjectionMatrix();
          isNorth = parseInt(document.getElementById('perspective').value);
          distance = parseInt(document.getElementById('camera').value);
          camera.position.set(0, isNorth * distance, 0);
          camera.lookAt(new THREE.Vector3(0,0,0));

          var frame = parseInt( document.getElementById('frame').textContent);
          var loy = parseFloat( document.getElementById('loy').textContent);
          var lom = parseFloat(document.getElementById('lom').textContent);
          var fps = parseFloat( document.getElementById('fps').value);
          frame += 1;
          earth.rotation.y = Math.PI * 2 * (frame / fps / 60);
          solar.rotation.y = Math.PI * 2 * (frame / fps / 60/loy);

          // solar motion
          var sin = Math.sin(Math.PI * 2 * frame/fps/60/loy);
          var cos = Math.cos(Math.PI * 2 * frame/fps/60/loy);
          directionalLight.position.set(cos, sin*Math.sin(Math.PI * 2 * 23.4 / 360), -sin);
          earth.position.y = -sin * 300; // approaching to celestial north pole

          // lunar motion
          radius = parseInt(document.getElementById('radius').value);
          var scale = radius / 300;
          earth.scale.setScalar(scale);
          earth.position.x = -Math.cos(Math.PI * frame/fps/60/loy * lom) * 225;
          earth.position.z = Math.sin(Math.PI * frame/fps/60/loy * lom) * 225;
          lunar.rotation.y = Math.PI * (frame/ fps/ 60 / loy * lom);
          document.getElementById('frame').textContent = frame;
          document.getElementById('solarday').textContent = dms(frame, fps, 'year');
          document.getElementById('lunarday').textContent = dms(frame, fps, 'month');
          document.getElementById('fpsd').textContent = '60/' + fps;
          document.getElementById('sin').textContent = sin;
          document.getElementById('cos').textContent = cos;
          // レンダリング
          renderer.render(scene, camera);

          requestAnimationFrame(tick);
          stats.update();
        }
      }

      function divideBy(s, unit){
        // unit should be year or month
        var d, subunit;
        if (unit == 'year') {
          d = 366.2422;
          subunit = 'season';
        } else if (unit == 'month'){
          d = 27.321;
          subunit = 'week';
        }
        let remainderSeconds = s % (86400 * (d / 4));
        let division1 = (s - remainderSeconds) / (86400 * d / 4); // total season or week
        let remainder1 = division1 % 4;
        let division = (division1 - remainder1) / 4
        return {division, remainder1, subunit, remainderSeconds}
      }

      function dms(frame, fps, unit){
        var s = frame / fps / 60 * 86400; // total seconds
        var {division, remainder1, subunit, remainderSeconds} = divideBy(s, unit);

        remainder = remainderSeconds % 86400;
        let day = (remainderSeconds-remainder) / 86400;
        remainder = remainder % 3600;
        let hour = (remainderSeconds - day*86400 - remainder) / 3600;
        let second = remainder % 60;
        let minute = (remainderSeconds - day*86400 - hour*3600 - second) / 60;
        return division.toFixed(0) + ' ' + unit + ' ' + remainder1.toFixed(0) + ' ' + subunit + ' ' + day.toFixed(0)+' day '+hour.toFixed(0)+':'+minute.toFixed(0)+':'+second.toFixed(2) + ' (' + s.toFixed(2) + ' seconds)'
      }
    </script>
  </head>
  <body>
    <canvas id="myCanvas"></canvas>
    <div id="panel" style="position:fixed; top:20; left:20; color:silver;">
      <label for="fov">fov: </label>
      <select id="fov">
        <option value="30">30</option>
        <option value="45" selected>45</option>
        <option value="60">60</option>
      </select>
      <label for="near">near: </label>
      <select id="near">
        <option value="1" selected>1</option>
        <option value="100">100</option>
        <option value="500">500</option>
      </select>
      <label for="far">far: </label>
      <select id="far">
        <option value="1500">1500</option>
        <option value="2000">2000</option>
        <option value="2500">2500</option>
        <option value="3000" selected>3000</option>
      </select>
      <label for="camera">camara distance</label>
      <select id="camera">
        <option value="1000" selected>1000</option>
        <option value="1500">1500</option>
        <option value="2000">2000</option>
        <option value="2500">2500</option>
      </select><br/>
      frame: <span id="frame">0</span><br/>
      <span id="solarday"></span><br/>
      <span id="lunarday"></span><br/>
      <label for="perspective">perspective</label>
      <select id="perspective">
        <option value="1" selected>North</option>
        <option value="-1">South</option>
      </select><br/>
      <label for="radius">radius</label>
      <select id="radius">
        <option value="200">200</option>
        <option value="300" selected>300</option>
        <option value="400">400</option>
        <option value="500">500</option>
      </select><br/>
      sidereal year: <span id="loy">366.2422</span><br/>
      sidereal month: <span id="lom">27.321</span><br/>
      fps:
      <select id="fps">
        <option value="86400" selected>x1</option>
        <option value="43200">x2</option>
        <option value="14400">x6</option>
        <option value="2880">x30</option>
        <option value="1440">1 min/sec (x60)</option>
        <option value="144">10 min/sec (x600)</option>
        <option value="24">1 hour/sec (x3600)</option>
        <option value="4">6 hours/sec (x14400)</option>
        <option value="1">1 day/sec (x86400)</option>
        <option value="0.146407">1 week /sec (x590133)</option>
        <option value="0.1">10 days/sec (x864000)</option>
        <option value="0.03660188">1 month /sec (x2360534)</option>
        <option value="0.002730433">1 year /sec (x31643326)</option>
      </select>
      <span id="fpsd"></span><br/>
      sin(theta): <span id="sin">0</span><br/>
      cos(theta): <span id="cos">0</span><br/>
  </div>
</body>
</html>
